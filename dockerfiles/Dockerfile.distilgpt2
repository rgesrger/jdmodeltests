# Use Ubuntu 22.04 (Matches your compilation environment)
FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# 1. Install dependencies
#    libgomp1 is required for ONNX Runtime concurrency
RUN apt-get update && apt-get install -y \
    wget \
    tar \
    libgomp1 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# 2. Install ONNX Runtime Global (No LD_LIBRARY_PATH needed)
#    We download, extract, move the lib to /usr/lib, and run ldconfig
RUN wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz \
    && tar -xzf onnxruntime-linux-x64-1.16.3.tgz \
    && cp onnxruntime-linux-x64-1.16.3/lib/libonnxruntime.so.1.16.3 /usr/lib/ \
    && ln -s /usr/lib/libonnxruntime.so.1.16.3 /usr/lib/libonnxruntime.so \
    && ldconfig \
    && rm -rf onnxruntime-linux-x64-1.16.3*

# 3. Create necessary directories
RUN mkdir -p /app /action

# 4. Copy your specific DistilBERT files
#    (Ensure these paths match your repo structure)
COPY junction-functions/distilbert/build/distilbert_infer /app/distilbert_infer
COPY junction-functions/distilbert/build/distilbert.onnx /app/distilbert.onnx

# 5. Copy your wrapper script
COPY dockerfiles/exec.sh /action/exec

# 6. Make everything executable
RUN chmod +x /app/distilbert_infer /action/exec

# 7. Set the OpenWhisk entrypoint
CMD ["/action/exec"]