# Use a lightweight Ubuntu base
FROM ubuntu:20.04

# Avoid prompts during install
ENV DEBIAN_FRONTEND=noninteractive

# Install minimal dependencies + wget, tar, libgomp for ONNX Runtime
RUN apt-get update && apt-get install -y \
    libstdc++6 \
    libgomp1 \
    wget \
    tar \
    && rm -rf /var/lib/apt/lists/*

# Download and install ONNX Runtime shared library
RUN wget https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz \
    && tar -xzf onnxruntime-linux-x64-1.16.3.tgz \
    && cp onnxruntime-linux-x64-1.16.3/lib/libonnxruntime.so.1.16.3 /usr/lib/ \
    && ldconfig \
    && rm -rf onnxruntime-linux-x64-1.16.3*

# Create directories for the binary and OpenWhisk action
RUN mkdir -p /app /action

# Copy the compiled model binary and ONNX model into the container
COPY junction-functions/distilgpt2/distilgpt2_infer /app/distilgpt2_infer
COPY models/distilgpt2.onnx /app/distilgpt2.onnx
COPY dockerfiles/exec.sh /action/exec

# Copy wrapper script that OpenWhisk will call

# Make everything executable
RUN chmod +x /app/distilgpt2_infer /action/exec

# Set OpenWhisk entrypoint
CMD ["/action/exec"]
